# 测试场景分析

## 1. 知识库测试场景

### 1.1 场景矩阵

```
┌─────────────────┬───────────────────────────────────────────────┐
│     操作类型     │                  数据规模                      │
│                 ├───────────────┬───────────────┬───────────────┤
│                 │  小 (100 docs) │ 中 (1K docs)  │ 大 (10K docs) │
├─────────────────┼───────────────┼───────────────┼───────────────┤
│ 文档上传        │      ✓        │      ✓        │      ✓        │
│ 索引构建        │      ✓        │      ✓        │      ✓        │
│ 单次检索        │      ✓        │      ✓        │      ✓        │
│ 批量检索        │      ✓        │      ✓        │      ✓        │
│ 并发检索        │      ✓        │      ✓        │      ✓        │
└─────────────────┴───────────────┴───────────────┴───────────────┘
```

### 1.2 详细场景描述

#### 场景 KB-001: 文档批量上传
- **目的**: 测试文档上传和预处理性能
- **输入**: 指定数量的测试文档（PDF、TXT、DOCX等）
- **测量指标**:
  - 上传吞吐量（docs/sec, MB/sec）
  - 单文档上传延迟
  - 失败率
- **变量**: 文档大小、文档格式、并发上传数

#### 场景 KB-002: 索引构建
- **目的**: 测试向量化和索引构建性能
- **输入**: 已上传的文档集
- **测量指标**:
  - 索引构建总时间
  - 单文档索引时间
  - 索引大小
- **变量**: 文档数量、chunk策略、embedding模型

#### 场景 KB-003: 检索延迟测试
- **目的**: 测试单次查询的响应时间
- **输入**: 标准查询集（来自BEIR等benchmark）
- **测量指标**:
  - P50/P95/P99 延迟
  - 首字节时间
- **变量**: 查询复杂度、TopK数量、过滤条件

#### 场景 KB-004: 检索吞吐测试
- **目的**: 测试系统最大处理能力
- **输入**: 大量并发查询请求
- **测量指标**:
  - 最大QPS
  - 吞吐量随并发数变化曲线
  - 错误率
- **变量**: 并发级别（1/10/50/100/500/1000）

#### 场景 KB-005: 检索质量测试
- **目的**: 评估检索结果的准确性
- **输入**: 带标注的查询-文档对（ground truth）
- **测量指标**:
  - Precision@K
  - Recall@K
  - MRR
  - NDCG@K
- **数据源**: BEIR benchmark子集

## 2. 记忆系统测试场景

### 2.1 场景矩阵

```
┌─────────────────┬───────────────────────────────────────────────┐
│     操作类型     │                  数据规模                      │
│                 ├───────────────┬───────────────┬───────────────┤
│                 │ 100条记忆     │ 1K条记忆      │ 10K条记忆     │
├─────────────────┼───────────────┼───────────────┼───────────────┤
│ 记忆写入        │      ✓        │      ✓        │      ✓        │
│ 记忆检索        │      ✓        │      ✓        │      ✓        │
│ 记忆更新        │      ✓        │      ✓        │      ✓        │
│ 并发读写        │      ✓        │      ✓        │      ✓        │
└─────────────────┴───────────────┴───────────────┴───────────────┘
```

### 2.2 详细场景描述

#### 场景 MEM-001: 记忆写入性能
- **目的**: 测试记忆存储的写入性能
- **输入**: 模拟对话产生的记忆数据
- **测量指标**:
  - 单条记忆写入延迟
  - 批量写入吞吐量
  - 写入成功率
- **变量**: 记忆长度、元数据复杂度

#### 场景 MEM-002: 记忆检索性能
- **目的**: 测试从大量历史记忆中召回相关记忆
- **输入**: 当前对话上下文作为查询
- **测量指标**:
  - 检索延迟
  - 召回相关性得分
- **变量**: 记忆库大小、查询复杂度、TopK数量

#### 场景 MEM-003: 跨会话记忆召回
- **目的**: 测试长期记忆的持久化和召回能力
- **输入**: 模拟多天跨会话的对话历史
- **测量指标**:
  - 召回准确率
  - 时间衰减对召回的影响
- **变量**: 时间跨度、用户数量

#### 场景 MEM-004: 并发读写测试
- **目的**: 测试高并发下的读写性能
- **输入**: 多用户同时读写记忆
- **测量指标**:
  - 读写延迟
  - 一致性
  - 冲突处理
- **变量**: 并发用户数、读写比例

## 3. 测试用例设计

### 3.1 知识库测试用例

| 用例ID | 场景 | 数据规模 | 并发数 | 预期结果 |
|--------|------|----------|--------|----------|
| KB-TC-001 | 文档上传 | 小 | 1 | 基准数据 |
| KB-TC-002 | 文档上传 | 中 | 1 | 线性扩展验证 |
| KB-TC-003 | 文档上传 | 大 | 1 | 大规模性能 |
| KB-TC-004 | 检索延迟 | 小 | 1 | 基准延迟 |
| KB-TC-005 | 检索延迟 | 中 | 1 | 规模影响 |
| KB-TC-006 | 检索延迟 | 大 | 1 | 规模影响 |
| KB-TC-007 | 并发检索 | 中 | 10 | 并发基准 |
| KB-TC-008 | 并发检索 | 中 | 50 | 中并发 |
| KB-TC-009 | 并发检索 | 中 | 100 | 高并发 |
| KB-TC-010 | 并发检索 | 中 | 500 | 压力测试 |
| KB-TC-011 | 检索质量 | 中 | 1 | 质量基准 |

### 3.2 记忆系统测试用例

| 用例ID | 场景 | 记忆数 | 并发数 | 预期结果 |
|--------|------|--------|--------|----------|
| MEM-TC-001 | 记忆写入 | 100 | 1 | 基准数据 |
| MEM-TC-002 | 记忆写入 | 1000 | 1 | 扩展性验证 |
| MEM-TC-003 | 记忆检索 | 100 | 1 | 基准延迟 |
| MEM-TC-004 | 记忆检索 | 1000 | 1 | 规模影响 |
| MEM-TC-005 | 记忆检索 | 10000 | 1 | 大规模性能 |
| MEM-TC-006 | 并发读写 | 1000 | 10 | 并发基准 |
| MEM-TC-007 | 并发读写 | 1000 | 50 | 中并发 |
| MEM-TC-008 | 并发读写 | 1000 | 100 | 高并发 |
| MEM-TC-009 | 跨会话召回 | 1000 | 1 | 长期记忆 |

## 4. 数据准备

### 4.1 知识库测试数据
- **来源**: BEIR benchmark 数据集
- **格式**: 转换为各平台支持的格式
- **标注**: 包含查询-文档相关性标注

### 4.2 记忆系统测试数据
- **来源**: 合成对话数据 + 开源对话数据集
- **内容**: 包含用户偏好、事实记忆、对话历史
- **结构**: 用户ID、会话ID、时间戳、记忆内容

## 5. 环境一致性

为保证对比公平性，需确保：

1. **资源配置一致**: 各云服务使用相同档位的资源配置
2. **数据一致**: 使用完全相同的测试数据集
3. **查询一致**: 使用相同的查询集和参数
4. **网络条件**: 从同一位置发起请求，或记录网络延迟
5. **时间窗口**: 在相近的时间段内完成测试，避免服务负载差异
