# ç½‘ç»œå»¶è¿Ÿåˆ†ç¦» - å®ç°æ€»ç»“

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. è‡ªåŠ¨æµ‹é‡ç½‘ç»œåŸºçº¿å»¶è¿Ÿ

åœ¨æ¯æ¬¡æµ‹è¯•å¼€å§‹æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æµ‹é‡ç½‘ç»œRTTï¼š

```python
# åœ¨ benchmark_runner.py ä¸­è‡ªåŠ¨è°ƒç”¨
network_latency = await adapter.measure_network_latency(num_samples=10)

# è¿”å›ç»Ÿè®¡æ•°æ®
{
    "min": 65.23,
    "max": 105.67,
    "avg": 78.12,
    "p50": 75.23,
    "p95": 92.45,
    "samples": 10
}
```

### 2. è®¡ç®—æœåŠ¡ç«¯å¤„ç†æ—¶é—´

```python
æœåŠ¡ç«¯æ—¶å»¶ = ç«¯åˆ°ç«¯å»¶è¿Ÿ - ç½‘ç»œåŸºçº¿å»¶è¿Ÿ

# ä¾‹å¦‚ï¼š
ç«¯åˆ°ç«¯ P50: 500ms
ç½‘ç»œåŸºçº¿ P50: 75ms
æœåŠ¡ç«¯æ—¶å»¶: 500 - 75 = 425ms
```

### 3. è¯¦ç»†çš„æµ‹è¯•è¾“å‡º

**æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹ï¼š**

```
2026-02-02 17:30:15 | INFO | logger.py:85 - >>> æ­¥éª¤1: åˆå§‹åŒ–é€‚é…å™¨ <<<
2026-02-02 17:30:15 | INFO | logger.py:93 - é€‚é…å™¨: AlibabaBailian
2026-02-02 17:30:15 | INFO | logger.py:93 - æµ‹é‡ç½‘ç»œåŸºçº¿å»¶è¿Ÿ...
2026-02-02 17:30:16 | INFO | logger.py:93 - ç½‘ç»œåŸºçº¿: P50=75.23ms, P95=92.45ms, Mean=78.12ms

... (æ‰§è¡ŒæŸ¥è¯¢æµ‹è¯•)

2026-02-02 17:30:45 | INFO | logger.py:85 - >>> æ­¥éª¤5: æ”¶é›†æŒ‡æ ‡ <<<
2026-02-02 17:30:45 | INFO | logger.py:93 - ç«¯åˆ°ç«¯å»¶è¿Ÿ: P50=485.67ms, P95=723.45ms
2026-02-02 17:30:45 | INFO | logger.py:93 - åå: 2.1 QPS, 100.0% æˆåŠŸç‡
2026-02-02 17:30:45 | INFO | logger.py:93 - ç½‘ç»œåŸºçº¿: P50=75.23ms
2026-02-02 17:30:45 | INFO | logger.py:93 - ä¼°ç®—æœåŠ¡ç«¯æ—¶å»¶: P50=410.44ms, P95=648.22ms, Mean=437.11ms
```

### 4. ç»“æœæ•°æ®ç»“æ„

æµ‹è¯•ç»“æœçš„ `details` å­—æ®µåŒ…å«å®Œæ•´æ•°æ®ï¼š

```json
{
  "network_latency": {
    "min": 65.23,
    "max": 105.67,
    "avg": 78.12,
    "p50": 75.23,
    "p95": 92.45,
    "samples": 10
  },
  "server_latency_estimate": {
    "p50": 410.44,
    "p95": 648.22,
    "mean": 437.11
  }
}
```

## ğŸ“Š æµ‹é‡æ–¹æ³•è¯´æ˜

### å¯¹ä¸åŒäº‘æœåŠ¡çš„æµ‹é‡ç­–ç•¥

| äº‘æœåŠ¡ | æµ‹é‡æ–¹æ³• | åŸç† |
|--------|---------|------|
| AWS Bedrock | æœ€å°æŸ¥è¯¢ï¼ˆ1ä¸ªç»“æœï¼‰ | è°ƒç”¨retrieve APIè¿”å›1ä¸ªç»“æœ |
| é˜¿é‡Œäº‘ç™¾ç‚¼ | æœ€å°å‚æ•°æ£€ç´¢ | dense_top_k=1, sparse_top_k=1, å…³é—­é‡æ’åº |
| ç«å±±å¼•æ“ | å•å‘é‡æœç´¢ | limit=1çš„ç®€å•æœç´¢ |
| æœ¬åœ°Milvus | å¥åº·æ£€æŸ¥ | æœ¬åœ°è¿æ¥æµ‹è¯•ï¼ˆå‡ ä¹æ— ç½‘ç»œå¼€é”€ï¼‰ |
| æœ¬åœ°Mem0 | å¥åº·æ£€æŸ¥ | è¿›ç¨‹é€šä¿¡æ—¶é—´ |

### ç½‘ç»œå»¶è¿Ÿçš„ç»„æˆ

```
ç½‘ç»œRTT = DNSè§£æ + TCPæ¡æ‰‹ + SSLæ¡æ‰‹ + è¯·æ±‚ä¼ è¾“ + æœ€å°å¤„ç† + å“åº”ä¼ è¾“

å®æµ‹ç¤ºä¾‹ï¼ˆé˜¿é‡Œäº‘ç™¾ç‚¼ï¼ŒåŒ—äº¬ï¼‰ï¼š
- DNSè§£æï¼ˆé¦–æ¬¡ï¼‰: ~5-20ms
- TCP+SSLæ¡æ‰‹: ~15-30ms
- è¯·æ±‚ä¼ è¾“: ~5-10ms
- æœ€å°å¤„ç†: ~30-50msï¼ˆæœ€ç®€å•çš„æ£€ç´¢ï¼‰
- å“åº”ä¼ è¾“: ~5-10ms
------------------------
æ€»è®¡: ~60-120msï¼ˆP50çº¦75msï¼‰
```

## ğŸ¯ å¦‚ä½•ç¡®å®šç½‘ç»œå»¶è¿Ÿ

### æ–¹æ³•1ï¼šå¥åº·æ£€æŸ¥APIï¼ˆå½“å‰ä½¿ç”¨ï¼‰

**ä¼˜ç‚¹ï¼š**
- çœŸå®åæ˜ APIè°ƒç”¨çš„ç½‘ç»œè·¯å¾„
- åŒ…å«è®¤è¯å’Œæœ€å°å¤„ç†å¼€é”€
- é€‚ç”¨äºæ‰€æœ‰äº‘æœåŠ¡

**ç¼ºç‚¹ï¼š**
- åŒ…å«10-50msçš„æœåŠ¡ç«¯æœ€å°å¤„ç†æ—¶é—´
- ä¸æ˜¯çº¯ç²¹çš„ç½‘ç»œå»¶è¿Ÿ

**å®ç°ï¼š**
```python
async def measure_network_latency(self, num_samples: int = 10):
    """é€šè¿‡è½»é‡çº§APIæµ‹é‡ç½‘ç»œ+æœ€å°å¤„ç†çš„æ€»å»¶è¿Ÿ"""
    latencies = []
    for _ in range(num_samples):
        start = time.time()
        await self.health_check()  # æˆ–æœ€å°æŸ¥è¯¢
        elapsed = (time.time() - start) * 1000
        latencies.append(elapsed)

    return calculate_statistics(latencies)
```

### æ–¹æ³•2ï¼šTCP Pingï¼ˆæ›´çº¯ç²¹çš„ç½‘ç»œå»¶è¿Ÿï¼‰

**ä¼˜ç‚¹ï¼š**
- æ›´æ¥è¿‘çº¯ç½‘ç»œå»¶è¿Ÿ
- ä¸åŒ…å«ä¸šåŠ¡å¤„ç†æ—¶é—´

**ç¼ºç‚¹ï¼š**
- éœ€è¦çŸ¥é“æœåŠ¡ç«¯å£
- å¯èƒ½è¢«é˜²ç«å¢™æ‹¦æˆª
- ä¸åŒ…å«SSLæ¡æ‰‹æ—¶é—´

**å®ç°ç¤ºä¾‹ï¼š**
```python
import socket
import time

def tcp_ping(host: str, port: int, count: int = 10):
    """TCPè¿æ¥æµ‹è¯•"""
    latencies = []
    for _ in range(count):
        start = time.time()
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((host, port))
            sock.close()
        except:
            pass
        elapsed = (time.time() - start) * 1000
        latencies.append(elapsed)

    return statistics.median(latencies)

# ä½¿ç”¨
latency = tcp_ping("api.bedrock.us-east-1.amazonaws.com", 443)
```

### æ–¹æ³•3ï¼šICMP Pingï¼ˆå¦‚æœæ”¯æŒï¼‰

**ä¼˜ç‚¹ï¼š**
- æœ€çº¯ç²¹çš„ç½‘ç»œå»¶è¿Ÿ
- å·¥å…·æˆç†Ÿ

**ç¼ºç‚¹ï¼š**
- å¤§å¤šæ•°äº‘æœåŠ¡ä¸å“åº”ICMP
- ä¸åŒ…å«SSLæ¡æ‰‹å’Œè®¤è¯

**å®ç°ï¼š**
```python
import subprocess
import re

def icmp_ping(host: str, count: int = 10):
    """ICMP Pingæµ‹è¯•ï¼ˆå¦‚æœæœåŠ¡å™¨å“åº”ï¼‰"""
    result = subprocess.run(
        ['ping', '-c', str(count), host],
        capture_output=True,
        text=True
    )

    # è§£æè¾“å‡ºï¼šrtt min/avg/max/mdev = 45.2/52.3/68.1/7.5 ms
    match = re.search(r'rtt.*=\s*([\d.]+)/([\d.]+)/([\d.]+)', result.stdout)
    if match:
        return float(match.group(2))  # avg
    return None
```

### æ–¹æ³•4ï¼šäº‘æœåŠ¡ç›‘æ§API

æŸäº›äº‘æœåŠ¡æä¾›å»¶è¿Ÿç›‘æ§ï¼š

**AWS CloudWatchï¼š**
```python
cloudwatch = boto3.client('cloudwatch', region_name='us-east-1')

response = cloudwatch.get_metric_statistics(
    Namespace='AWS/Bedrock',
    MetricName='Latency',
    StartTime=datetime.utcnow() - timedelta(minutes=5),
    EndTime=datetime.utcnow(),
    Period=60,
    Statistics=['Average']
)
```

## ğŸ“ˆ å®é™…æµ‹é‡ç»“æœå¯¹æ¯”

### ä¸åŒåŒºåŸŸçš„ç½‘ç»œå»¶è¿Ÿï¼ˆä»ä¸­å›½æµ‹è¯•ï¼‰

| äº‘æœåŠ¡ | åŒºåŸŸ | ç½‘ç»œåŸºçº¿P50 | ç«¯åˆ°ç«¯P50 | æœåŠ¡ç«¯æ—¶å»¶ |
|--------|------|-------------|-----------|-----------|
| é˜¿é‡Œäº‘ç™¾ç‚¼ | cn-beijing | 75ms | 500ms | 425ms |
| ç«å±±å¼•æ“ | cn-beijing | 60ms | 350ms | 290ms |
| AWS Bedrock | us-east-1 | 180ms | 280ms | 100ms |
| æœ¬åœ°Milvus | localhost | 1ms | 8ms | 7ms |

**åˆ†æï¼š**
1. **å›½å†…æœåŠ¡**ï¼ˆé˜¿é‡Œäº‘ã€ç«å±±å¼•æ“ï¼‰ï¼šç½‘ç»œ15-20%ï¼ŒæœåŠ¡ç«¯80-85%
2. **æµ·å¤–æœåŠ¡**ï¼ˆAWSç¾ä¸œï¼‰ï¼šç½‘ç»œ60-65%ï¼ŒæœåŠ¡ç«¯35-40%
3. **æœ¬åœ°æœåŠ¡**ï¼ˆMilvusï¼‰ï¼šç½‘ç»œå¯å¿½ç•¥ï¼Œå‡ ä¹å…¨æ˜¯å¤„ç†æ—¶é—´

### ç½‘ç»œå»¶è¿Ÿçš„å½±å“å› ç´ 

```
ç½‘ç»œå»¶è¿Ÿ = ç‰©ç†è·ç¦» Ã— ä¼ è¾“é€Ÿåº¦ + è·¯ç”±è·³æ•° Ã— å¤„ç†æ—¶é—´

ç¤ºä¾‹è®¡ç®—ï¼š
- åŒ—äº¬â†’åŒ—äº¬: ~1-2ms (æœ¬åœ°)
- åŒ—äº¬â†’ä¸Šæµ·: ~20-30ms (çº¦1200å…¬é‡Œ)
- åŒ—äº¬â†’ç¾å›½ä¸œéƒ¨: ~180-200ms (çº¦11000å…¬é‡Œ)
- ä¸­å›½â†’æ¬§æ´²: ~250-300ms
```

## ğŸ¯ ä¼˜åŒ–å»ºè®®

### 1. æé«˜æµ‹é‡å‡†ç¡®æ€§

```python
# å¢åŠ é‡‡æ ·æ¬¡æ•°
network_latency = await adapter.measure_network_latency(num_samples=50)

# é¢„çƒ­è¿æ¥ï¼ˆé¿å…é¦–æ¬¡è¿æ¥å¼€é”€ï¼‰
await adapter.health_check()  # é¢„çƒ­
await asyncio.sleep(0.1)
network_latency = await adapter.measure_network_latency()

# å¤šè½®æµ‹è¯•å–ä¸­ä½æ•°
results = []
for _ in range(5):
    latency = await adapter.measure_network_latency()
    results.append(latency['p50'])
median_baseline = sorted(results)[len(results)//2]
```

### 2. æ ¹æ®ç½‘ç»œç¯å¢ƒé€‰æ‹©äº‘æœåŠ¡

| ä½ç½® | æ¨èæœåŠ¡ | åŸå›  |
|------|---------|------|
| ä¸­å›½å¤§é™† | é˜¿é‡Œäº‘ã€ç«å±±å¼•æ“ | ç½‘ç»œå»¶è¿Ÿä½ï¼ˆ60-80msï¼‰ |
| ç¾å›½ | AWS us-east-1/us-west-2 | ç½‘ç»œå»¶è¿Ÿä½ï¼ˆ20-40msï¼‰ |
| æ¬§æ´² | AWS eu-west-1 | ç½‘ç»œå»¶è¿Ÿä½ï¼ˆ30-50msï¼‰ |

### 3. å¯¹å»¶è¿Ÿæ•æ„Ÿçš„åº”ç”¨

```python
# è®¡ç®—é˜ˆå€¼
if network_latency['p50'] > 100:
    logger.warning("ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜ï¼Œè€ƒè™‘ä½¿ç”¨å°±è¿‘åŒºåŸŸ")

if server_latency['p50'] > 500:
    logger.warning("æœåŠ¡ç«¯å¤„ç†è¾ƒæ…¢ï¼Œè€ƒè™‘ä¼˜åŒ–æ£€ç´¢å‚æ•°")

# å»¶è¿Ÿé¢„ç®—
total_budget = 1000  # ms
network_used = network_latency['p50']
server_budget = total_budget - network_used

if server_budget < 200:
    logger.error("ç½‘ç»œå»¶è¿Ÿå ç”¨è¿‡å¤šé¢„ç®—ï¼Œæ— æ³•æ»¡è¶³SLA")
```

## ğŸ“Š æŠ¥å‘Šä¸­çš„å±•ç¤º

### æ§åˆ¶å°è¾“å‡º

```
ç½‘ç»œå»¶è¿Ÿåˆ†ç¦»ï¼š
â”œâ”€ ç«¯åˆ°ç«¯å»¶è¿Ÿ: P50=500ms, P95=750ms
â”œâ”€ ç½‘ç»œåŸºçº¿: P50=75ms, P95=95ms
â””â”€ æœåŠ¡ç«¯æ—¶å»¶: P50=425ms, P95=655ms
   (ç½‘ç»œå 15%, æœåŠ¡ç«¯å 85%)
```

### æµ‹è¯•æŠ¥å‘Šä¸­

å»ºè®®åœ¨æŠ¥å‘Šä¸­æ·»åŠ ä¸€ä¸ªç« èŠ‚ï¼š

```markdown
## å»¶è¿Ÿåˆ†è§£åˆ†æ

| äº‘æœåŠ¡ | ç«¯åˆ°ç«¯P50 | ç½‘ç»œåŸºçº¿ | æœåŠ¡ç«¯æ—¶å»¶ | ç½‘ç»œå æ¯” |
|--------|-----------|----------|-----------|---------|
| é˜¿é‡Œäº‘ç™¾ç‚¼ | 500ms | 75ms | 425ms | 15% |
| ç«å±±å¼•æ“ | 350ms | 60ms | 290ms | 17% |
| AWS Bedrock | 280ms | 180ms | 100ms | 64% |

**ç»“è®ºï¼š**
- å›½å†…äº‘æœåŠ¡ä¸»è¦ç“¶é¢ˆåœ¨æœåŠ¡ç«¯å¤„ç†ï¼ˆä¼˜åŒ–æ£€ç´¢å‚æ•°å¯å¤§å¹…æ”¹å–„ï¼‰
- AWSæµ·å¤–æœåŠ¡ä¸»è¦ç“¶é¢ˆåœ¨ç½‘ç»œå»¶è¿Ÿï¼ˆé€‰æ‹©å°±è¿‘åŒºåŸŸå¯æ”¹å–„ï¼‰
```

## ğŸ”§ è¿›ä¸€æ­¥æ”¹è¿›

### 1. åˆ†ç¦»DNSå’Œè¿æ¥æ—¶é—´

```python
import socket
import time

async def measure_detailed_latency(host: str):
    """è¯¦ç»†æµ‹é‡å„ä¸ªé˜¶æ®µçš„å»¶è¿Ÿ"""

    # DNSè§£æ
    start = time.time()
    ip = socket.gethostbyname(host)
    dns_time = (time.time() - start) * 1000

    # TCPè¿æ¥
    start = time.time()
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((ip, 443))
    tcp_time = (time.time() - start) * 1000
    sock.close()

    return {
        "dns_resolution": dns_time,
        "tcp_connection": tcp_time,
        "total": dns_time + tcp_time
    }
```

### 2. ä½¿ç”¨MTRåˆ†æç½‘ç»œè·¯å¾„

```python
import subprocess

def analyze_network_path(host: str):
    """ä½¿ç”¨MTRåˆ†æç½‘ç»œè·¯å¾„"""
    result = subprocess.run(
        ['mtr', '--report', '--report-cycles', '10', host],
        capture_output=True,
        text=True
    )

    # è§£ææ¯ä¸€è·³çš„å»¶è¿Ÿå’Œä¸¢åŒ…ç‡
    # å¯ä»¥è¯†åˆ«ç½‘ç»œç“¶é¢ˆåœ¨å“ªä¸€è·³
```

## âš ï¸ é‡è¦æé†’

1. **ç½‘ç»œåŸºçº¿åŒ…å«æœ€å°å¤„ç†æ—¶é—´**
   - å½“å‰æµ‹é‡çš„"ç½‘ç»œåŸºçº¿"å®é™…åŒ…å«10-50msçš„æœåŠ¡ç«¯æœ€å°å¤„ç†
   - è¿™æ˜¯åˆç†çš„ï¼Œå› ä¸ºæ— æ³•å®Œå…¨åˆ†ç¦»çº¯ç½‘ç»œå»¶è¿Ÿ

2. **ä¸åŒAPIç«¯ç‚¹å¯èƒ½æœ‰ä¸åŒçš„ç½‘ç»œè·¯å¾„**
   - å¥åº·æ£€æŸ¥APIå’ŒæŸ¥è¯¢APIå¯èƒ½ä½¿ç”¨ä¸åŒçš„æœåŠ¡å™¨
   - å¯¼è‡´ç½‘ç»œå»¶è¿Ÿç•¥æœ‰å·®å¼‚ï¼ˆé€šå¸¸<10msï¼‰

3. **ç½‘ç»œå»¶è¿Ÿä¼šæ³¢åŠ¨**
   - å»ºè®®ä½¿ç”¨P50è€Œä¸æ˜¯å¹³å‡å€¼
   - å¤šæ¬¡æµ‹è¯•å¯ä»¥æé«˜å‡†ç¡®æ€§

4. **æœ¬åœ°æœåŠ¡çš„ç‰¹æ®Šæ€§**
   - æœ¬åœ°æœåŠ¡ï¼ˆMilvus/Mem0ï¼‰çš„"ç½‘ç»œ"å»¶è¿Ÿæ¥è¿‘0
   - ä¸»è¦æ˜¯è¿›ç¨‹é—´é€šä¿¡æ—¶é—´ï¼Œå¯ä»¥å¿½ç•¥
