# 本地开发与调试设计

## 1. 本地替代方案

为了在本地调试系统，使用以下开源库作为云服务的本地替代：

| 云服务类型 | 本地替代 | 说明 |
|-----------|---------|------|
| 知识库 (5个云服务) | ChromaDB | 轻量级向量数据库，无需额外服务 |
| 记忆系统 (4个云服务) | mem0 (本地模式) | 已在测试列表中，直接复用 |

## 2. 运行模式

```
┌─────────────────────────────────────────────────────────────┐
│                      运行模式切换                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   config.yaml:                                               │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  mode: "local"    # local | cloud | hybrid          │   │
│   │                                                      │   │
│   │  # local 模式: 全部使用本地开源库                      │   │
│   │  # cloud 模式: 全部使用云服务                         │   │
│   │  # hybrid 模式: 指定哪些用本地，哪些用云服务            │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
│   适配器自动选择:                                            │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  if mode == "local":                                │   │
│   │      kb_adapter = ChromaDBAdapter()                 │   │
│   │      mem_adapter = Mem0LocalAdapter()               │   │
│   │  elif mode == "cloud":                              │   │
│   │      kb_adapter = AWSBedrockKBAdapter()  # etc      │   │
│   │      mem_adapter = AWSBedrockMemoryAdapter()        │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 3. 调试日志设计

### 3.1 日志级别

```
DEBUG  - 详细的内部状态，变量值
INFO   - 关键步骤完成通知
WARNING- 可恢复的问题
ERROR  - 操作失败
```

### 3.2 结构化日志输出示例

```
[2024-01-15 10:30:00] INFO  | ========== 测试开始 ==========
[2024-01-15 10:30:00] INFO  | 模式: local
[2024-01-15 10:30:00] INFO  | 适配器: ChromaDBAdapter
[2024-01-15 10:30:00] INFO  | 数据规模: small (10 docs)
[2024-01-15 10:30:00] INFO  | --------------------------------

[2024-01-15 10:30:01] INFO  | [步骤 1/5] 初始化适配器
[2024-01-15 10:30:01] DEBUG |   → 连接 ChromaDB (in-memory)
[2024-01-15 10:30:01] DEBUG |   → 创建 collection: test_kb_001
[2024-01-15 10:30:01] INFO  |   ✓ 初始化完成 (0.12s)

[2024-01-15 10:30:02] INFO  | [步骤 2/5] 上传文档
[2024-01-15 10:30:02] DEBUG |   → 文档数量: 10
[2024-01-15 10:30:02] DEBUG |   → 文档 1/10: doc_001.txt (2.3KB)
[2024-01-15 10:30:02] DEBUG |   → 文档 2/10: doc_002.txt (1.8KB)
...
[2024-01-15 10:30:05] INFO  |   ✓ 上传完成 (3.21s), 成功: 10, 失败: 0

[2024-01-15 10:30:05] INFO  | [步骤 3/5] 构建索引
[2024-01-15 10:30:05] DEBUG |   → Embedding 模型: all-MiniLM-L6-v2
[2024-01-15 10:30:06] INFO  |   ✓ 索引完成 (1.05s)

[2024-01-15 10:30:06] INFO  | [步骤 4/5] 执行查询测试
[2024-01-15 10:30:06] DEBUG |   → 查询 1/5: "What is machine learning?"
[2024-01-15 10:30:06] DEBUG |     结果: [doc_003 (0.89), doc_007 (0.76), doc_001 (0.65)]
[2024-01-15 10:30:06] DEBUG |     延迟: 45ms
...
[2024-01-15 10:30:08] INFO  |   ✓ 查询完成, 平均延迟: 52ms

[2024-01-15 10:30:08] INFO  | [步骤 5/5] 收集指标
[2024-01-15 10:30:08] INFO  |   ✓ 指标收集完成

[2024-01-15 10:30:08] INFO  | ========== 测试结果 ==========
[2024-01-15 10:30:08] INFO  | 延迟 P50: 48ms | P95: 67ms | P99: 82ms
[2024-01-15 10:30:08] INFO  | 吞吐量: 19.2 QPS
[2024-01-15 10:30:08] INFO  | ================================
```

## 4. 小数据量调试配置

```yaml
# config/config.local.yaml
mode: "local"

debug:
  verbose: true          # 详细日志
  log_level: "DEBUG"
  print_results: true    # 打印每次查询结果
  save_raw_data: true    # 保存原始数据便于分析

# 小数据量配置
data:
  scale: "tiny"          # tiny: 10 docs, small: 100 docs

  tiny:
    doc_count: 10
    queries_count: 5
    memories_count: 20

local:
  # ChromaDB 配置
  chromadb:
    persist_directory: null  # null = in-memory, 或指定路径持久化
    embedding_model: "all-MiniLM-L6-v2"  # 本地小模型，快速

  # mem0 本地配置
  mem0:
    vector_store: "chroma"   # 使用 ChromaDB 作为向量存储
    embedding_model: "all-MiniLM-L6-v2"
```

## 5. 开发流程

```
阶段 1: 本地调试 (当前)
├── 使用 tiny 数据集 (10 docs)
├── ChromaDB + mem0 本地模式
├── 详细日志输出
└── 验证整个流程正确

阶段 2: 本地扩展测试
├── 使用 small 数据集 (100 docs)
├── 验证性能指标计算正确
└── 验证报告生成正确

阶段 3: 云服务测试
├── 逐个接入云服务适配器
├── 使用相同测试数据
└── 对比结果
```
